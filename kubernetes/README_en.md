






























# Hybrid API-Platform - Kubernetes

We recommend the hybrid deployment method for clients concerned about latency. This documentation explains how to deploy the modules/services used on the hybrid environment using [Kubernetes](https://kubernetes.io) and [Helm](https://helm.sh).

The hybrid environment comprises modules developed by Sensedia and infrastructure components.

Infrastructure components, as well as their operation and support, are the client's responsibility. Thus, the infrastructure, as well as the responsible team, must be capable of providing:

* Ingress/egress
* Load balancing
* Backup
* Monitoramento

Table 1. Services executed/maintained by the client on the hybrid environment

| **Resource** | **Options** | **Details** |
| --- | --- | --- |
| Ingress/Load Balancer | HTTP/HTTPS load balancer (_example: ALB / F5 / NGINX / Traefik etc_). | Certificates must be applied on the balancing layer. |
| Backup | Any solution that copies Redis data retention file (_\*.rdb_) for (_safe_) external storage. | This file needs to be protected because it contains sensitive information (_example: access token_). |
| Monitoring | Any monitoring solution that supports HTTP health checks. | All hybrid modules expose metrics through the endpoint ``/metrics``. The only exception is the Gateway, which exposes metrics through the endpoint ``/gateway-admin/metrics``. |

# Hybrid Environment Modules

Table 2: Ingress, LB and Backup requirement description by module.

| **Module** | **Description** | **Is there a need for load balancing?** | **Is there a need for backup** |
| --- | --- | --- | --- |
| Agent-authorization | Scenario transfer between Cloud Sensedia and Hybrid Authorization. | No | No |
| Agent-gateway | Scenario transfer between Cloud Sensedia and Hybrid Gateway. | No | No |
| Gateway | Responsible for processing messages. | Yes | No |
| Authorization | Responsible for token pela generation. | Yes | No |
| Logstash-federated | Transfer of analytical data and token audit for Cloud Sensedia. | Optional | No |
| Redis | Memory grid to share information across modules. | No | Yes (usually \*.rdb) |

# Supported Deployment Modelos

Table 3. Provisioning options by module

| **Module** | **Kubernetes** | **Docker** | **VM (Centos / Red Hat 7)** | **Managed Services** |
| --- | --- | --- | --- | --- |
| Agent-authorization | Yes | Yes | Yes (on docker-compose) | N/A |
| Agent-gateway | Yes | Yes | Yes (on docker-compose) | N/A |
| Gateway | Yes | Yes | Yes (on docker-compose) | N/A |
| Authorization | Yes | Yes | Yes (on docker-compose) | N/A |
| Logstash-federated | Yes | Yes | Yes (on docker-compose) | N/A |
| Redis (>= 4.0.11) | Free choice ||| - ElastiCache (AWS) <br> - Memorystore (GCP) |
| Ingress | Yes (service/ingress) | Yes (Client's load balancer) | Yes (Client's load balancer) | - ELB / ALB (AWS) <br> - Compute Load Balancer (GCP) |

# Macro Topology

Figure 1. Representation of the modules and connections of the Hybrid Model.

![API-Platform: topology](../images/api-platform_topology.png)

# Installation Requirements

The following sections present the installation requirements for API-Platform on a hybrid environment.

## Customer ID creation

``customerID`` is a unique identifier for each client and it's generated by Sensedia.

Obtain your ``customerid`` with the Support team. You will need it to fine tune the configuration of helm chart parameters for some API-Platform modules.

Exemple of ``customerid`` being set in a configuration file:

```
customerId: "CHANGE_HERE"
```

## Token creation

The configuration of the hybrid environment
